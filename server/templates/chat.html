<!DOCTYPE html>
<html lang="en" class="fill">
  <head>
    <link href="{{ url_for('static', filename='css/bootstrap.css') }}" rel="stylesheet">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap 101 Template</title>
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body class="fill">
<div class="container fill">
    <div class="col-lg-12 fill">
        <div id="messages">

        </div>
          <label for="chatbox">Say something to your new friend</label>
          <textarea class="form-control border" id="chatbox" onkeypress="enterCheck()" rows="3"></textarea>
    </div>
</div>

  </body>

  <script src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/bootstrap.js') }}"></script>
  <script src="{{ url_for('static', filename='js/axios.min.js') }}"></script>
  <script>
  function enterCheck() {
    console.log('outerfuction')
    var keyPress = window.event.keyCode;

    if (keyPress === 13) {
      console.log('here')
      axios.post('/chat', {
        'User' : window.location.pathname.substr(10),
        'Message' : document.getElementById('chatbox').value,
        'Time' : Date.now()
      }).then(function(response){
        if(response.data.status_code === 200){
          console.log(response.data.chat)
          $("#chatbox").val('')
        } else {
          alert(response.data.message)
        }
      }).catch(function(error){
        console.log(error)
      })
    }
  }

  var highest = -1

  var requestLoop = setInterval(function(){
    axios.get('/chat').then(function(response){
      if(response.data.status_code === 200){
        for (var key in response.data.chat){
          if (parseInt(key) > highest){
            console.log(response.data.chat[key])
            $('<div class="message">' + response.data.chat[key].User + ' : ' + response.data.chat[key].Message + '</p>').appendTo('#messages');
            highest = parseInt(key)
          }
        }
      } else {
        alert(response.data.message)
      }
    }).catch(function(error){
      console.log(error)
    })
  }, 1000);

  requestLoop
  </script>
</html>

<style>
  .fill {
    height: -moz-calc(100%); /* Firefox */
    height: -webkit-calc(100%); /* Chrome, Safari */
    height: calc(100%); /* IE9+ and future browsers */
}

html, body {
    height: -moz-calc(100%); /* Firefox */
    height: -webkit-calc(100%); /* Chrome, Safari */
    height: calc(100%); /* IE9+ and future browsers */
}

#messages{
  height: -moz-calc(75%); /* Firefox */
  height: -webkit-calc(75%); /* Chrome, Safari */
  height: calc(75%); /* IE9+ and future browsers */
  overflow-y: auto;
}

#chatbox{
  height: -moz-calc(21%); /* Firefox */
  height: -webkit-calc(21%); /* Chrome, Safari */
  height: calc(21%); /* IE9+ and future browsers */
}

textarea {
    resize: none;
}

</style>
